name: ðŸš€ Deploy to Server

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - "staging"
          - "production"
      service:
        description: "é€‰æ‹©è¦éƒ¨ç½²çš„æœåŠ¡ (all è¡¨ç¤ºå…¨éƒ¨)"
        required: true
        default: "all"
        type: choice
        options:
          - "all"
          - "web"
          - "api-gateway"
          - "registry"
          - "auth-service"
          - "user-service"
          - "workflow-service"
      image_tag:
        description: "é•œåƒæ ‡ç­¾"
        required: false
        default: "latest"
        type: string
      force_recreate:
        description: "å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/telos

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ è®¾ç½®éƒ¨ç½²å˜é‡
        id: vars
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "compose_file=docker-compose.yml" >> $GITHUB_OUTPUT
            echo "env_file=.env.production" >> $GITHUB_OUTPUT
          else
            echo "compose_file=docker-compose.yml" >> $GITHUB_OUTPUT
            echo "env_file=.env.staging" >> $GITHUB_OUTPUT
          fi

          if [[ "${{ github.event.inputs.force_recreate }}" == "true" ]]; then
            echo "compose_flags=--force-recreate" >> $GITHUB_OUTPUT
          else
            echo "compose_flags=" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”§ å‡†å¤‡çŽ¯å¢ƒå˜é‡
        run: |
          # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
          cat > .env << EOF
          # é•œåƒé…ç½®
          REGISTRY=${{ env.REGISTRY }}
          IMAGE_PREFIX=${{ env.IMAGE_PREFIX }}
          IMAGE_TAG=${{ github.event.inputs.image_tag }}

          # åº”ç”¨é…ç½®
          NODE_ENV=${{ github.event.inputs.environment }}

          # æ•°æ®åº“é…ç½®
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=telos_${{ github.event.inputs.environment }}
          DB_USER=telos
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          # Redis é…ç½®
          REDIS_HOST=redis
          REDIS_PORT=6379

          # è®¤è¯é…ç½®
          AUTH_SECRET=${{ secrets.AUTH_SECRET }}
          GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}

          # API é…ç½®
          NEXT_PUBLIC_API_URL=${{ vars.API_URL || 'http://localhost:8080' }}
          NEXT_PUBLIC_DOMAIN=${{ vars.DOMAIN || 'localhost:8800' }}
          EOF

      - name: ðŸ”„ æ›´æ–° Docker Compose é…ç½®
        run: |
          # æ›´æ–° docker-compose.yml ä½¿ç”¨çŽ¯å¢ƒå˜é‡ä¸­çš„é•œåƒ
          sed -i 's|build:|# build:|g' docker-compose.yml
          sed -i 's|context: \.|# context: \.|g' docker-compose.yml
          sed -i 's|dockerfile: \(.*\)|# dockerfile: \1|g' docker-compose.yml

          # æ·»åŠ é•œåƒé…ç½®
          services=("web" "api-gateway" "registry" "auth-service" "user-service" "workflow-service")

          for service in "${services[@]}"; do
            # åœ¨æ¯ä¸ªæœåŠ¡çš„ container_name è¡ŒåŽæ·»åŠ  image é…ç½®
            sed -i "/container_name: telos-${service}/a\\    image: \${REGISTRY}/\${IMAGE_PREFIX}-${service}:\${IMAGE_TAG}" docker-compose.yml
          done

      - name: ðŸ³ æ‹‰å– Docker é•œåƒ
        run: |
          services="${{ github.event.inputs.service }}"

          if [[ "$services" == "all" ]]; then
            docker-compose pull
          else
            docker-compose pull "$services"
          fi

      - name: ðŸš€ éƒ¨ç½²æœåŠ¡
        run: |
          services="${{ github.event.inputs.service }}"
          flags="${{ steps.vars.outputs.compose_flags }}"

          if [[ "$services" == "all" ]]; then
            docker-compose up -d $flags
          else
            docker-compose up -d $flags "$services"
          fi

      - name: â³ ç­‰å¾…æœåŠ¡å¯åŠ¨
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30

      - name: ðŸ¥ å¥åº·æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."

          services="${{ github.event.inputs.service }}"
          if [[ "$services" == "all" ]]; then
            check_services=("registry" "api-gateway" "auth-service" "user-service" "workflow-service" "web")
          else
            check_services=("$services")
          fi

          failed_services=()

          for service in "${check_services[@]}"; do
            echo "æ£€æŸ¥ $service æœåŠ¡..."
            
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
            if ! docker-compose ps "$service" | grep -q "Up"; then
              echo "âŒ $service æœåŠ¡æœªè¿è¡Œ"
              failed_services+=("$service")
              continue
            fi
            
            # æ ¹æ®æœåŠ¡ç±»åž‹è¿›è¡Œå¥åº·æ£€æŸ¥
            case "$service" in
              "web")
                if curl -f http://localhost:8800/api/health 2>/dev/null; then
                  echo "âœ… $service æœåŠ¡å¥åº·"
                else
                  echo "âš ï¸ $service æœåŠ¡å¯èƒ½æœªå®Œå…¨å¯åŠ¨"
                fi
                ;;
              "api-gateway")
                if curl -f http://localhost:8080/health 2>/dev/null; then
                  echo "âœ… $service æœåŠ¡å¥åº·"
                else
                  echo "âš ï¸ $service æœåŠ¡å¯èƒ½æœªå®Œå…¨å¯åŠ¨"
                fi
                ;;
              *)
                echo "âœ… $service å®¹å™¨è¿è¡Œä¸­"
                ;;
            esac
          done

          if [[ ${#failed_services[@]} -gt 0 ]]; then
            echo "âŒ ä»¥ä¸‹æœåŠ¡éƒ¨ç½²å¤±è´¥: ${failed_services[*]}"
            exit 1
          fi

      - name: ðŸ“Š éƒ¨ç½²çŠ¶æ€
        run: |
          echo "## ðŸš€ éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²å‚æ•°:**" >> $GITHUB_STEP_SUMMARY
          echo "- çŽ¯å¢ƒ: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- æœåŠ¡: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- é•œåƒæ ‡ç­¾: ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- å¼ºåˆ¶é‡æ–°åˆ›å»º: ${{ github.event.inputs.force_recreate }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æœåŠ¡çŠ¶æ€:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker-compose ps >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ æ¸…ç†
        if: always()
        run: |
          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
          docker image prune -f

          # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
          df -h

  rollback:
    if: failure()
    needs: deploy
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”„ å›žæ»šéƒ¨ç½²
        run: |
          echo "éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›žæ»š..."

          # è¿™é‡Œå¯ä»¥å®žçŽ°å›žæ»šé€»è¾‘
          # ä¾‹å¦‚ï¼šæ¢å¤åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„é•œåƒ
          echo "å›žæ»šåŠŸèƒ½éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å®žçŽ°"
          echo "å»ºè®®ä½¿ç”¨é•œåƒæ ‡ç­¾ç®¡ç†å’Œæ•°æ®åº“è¿ç§»ç‰ˆæœ¬æŽ§åˆ¶"

      - name: ðŸ“¢ é€šçŸ¥å›žæ»š
        run: |
          echo "## âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œå·²è§¦å‘å›žæ»š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åŽé‡æ–°éƒ¨ç½²ã€‚" >> $GITHUB_STEP_SUMMARY
