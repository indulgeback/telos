name: ðŸ”„ CI/CD Pipeline

on:
  push:
    branches: [main, dev]
    paths:
      - "apps/**"
      - "services/**"
      - "docker-compose*.yml"
      - "Dockerfile*"
  pull_request:
    branches: [main, dev]
    paths:
      - "apps/**"
      - "services/**"
      - "docker-compose*.yml"
      - "Dockerfile*"

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/telos

jobs:
  # æ£€æµ‹å˜æ›´çš„æœåŠ¡
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.changes.outputs.web }}
      mobile: ${{ steps.changes.outputs.mobile }}
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      registry: ${{ steps.changes.outputs.registry }}
      auth-service: ${{ steps.changes.outputs.auth-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      workflow-service: ${{ steps.changes.outputs.workflow-service }}
      any-service: ${{ steps.changes.outputs.any-service }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            web:
              - 'apps/web/**'
            mobile:
              - 'apps/mobile/**'
            api-gateway:
              - 'apps/api-gateway/**'
            registry:
              - 'apps/registry/**'
            auth-service:
              - 'services/auth-service/**'
            user-service:
              - 'services/user-service/**'
            workflow-service:
              - 'services/workflow-service/**'
            any-service:
              - 'apps/**'
              - 'services/**'
              - 'docker-compose*.yml'
              - 'Dockerfile*'

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.any-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: ðŸ“¦ è®¾ç½® Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24.4"

      - name: ðŸ” å®‰è£…å‰ç«¯ä¾èµ–
        if: needs.detect-changes.outputs.web == 'true' || needs.detect-changes.outputs.mobile == 'true'
        run: |
          if [[ "${{ needs.detect-changes.outputs.web }}" == "true" ]]; then
            cd apps/web
            pnpm install --frozen-lockfile
            cd ../..
          fi
          if [[ "${{ needs.detect-changes.outputs.mobile }}" == "true" ]]; then
            cd apps/mobile
            pnpm install --frozen-lockfile
            cd ../..
          fi

      - name: ðŸ” Web åº”ç”¨ä»£ç æ£€æŸ¥
        if: needs.detect-changes.outputs.web == 'true'
        run: |
          cd apps/web
          pnpm lint
          pnpm format:check

      - name: ðŸ—ï¸ Web åº”ç”¨æž„å»ºæµ‹è¯•
        if: needs.detect-changes.outputs.web == 'true'
        run: |
          cd apps/web
          pnpm build

      - name: ðŸ” Go æœåŠ¡ä»£ç æ£€æŸ¥
        if: |
          needs.detect-changes.outputs.api-gateway == 'true' ||
          needs.detect-changes.outputs.registry == 'true' ||
          needs.detect-changes.outputs.auth-service == 'true' ||
          needs.detect-changes.outputs.user-service == 'true' ||
          needs.detect-changes.outputs.workflow-service == 'true'
        run: |
          services=()
          [[ "${{ needs.detect-changes.outputs.api-gateway }}" == "true" ]] && services+=("apps/api-gateway")
          [[ "${{ needs.detect-changes.outputs.registry }}" == "true" ]] && services+=("apps/registry")
          [[ "${{ needs.detect-changes.outputs.auth-service }}" == "true" ]] && services+=("services/auth-service")
          [[ "${{ needs.detect-changes.outputs.user-service }}" == "true" ]] && services+=("services/user-service")
          [[ "${{ needs.detect-changes.outputs.workflow-service }}" == "true" ]] && services+=("services/workflow-service")

          for service in "${services[@]}"; do
            echo "æ£€æŸ¥ $service..."
            cd "$service"
            
            # æ£€æŸ¥ go.mod æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "go.mod" ]]; then
              echo "âš ï¸ go.mod æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ $service"
              cd - > /dev/null
              continue
            fi
            
            go mod tidy
            go fmt ./...
            go vet ./...
            
            # å°è¯•æž„å»º
            if [[ -d "cmd" ]]; then
              echo "æž„å»º $service..."
              go build -v ./cmd/...
            fi
            
            cd - > /dev/null
          done

  # æž„å»ºå’ŒæŽ¨é€é•œåƒ
  build-and-push:
    needs: [detect-changes, lint-and-test]
    if: needs.detect-changes.outputs.any-service == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - service: web
            condition: ${{ needs.detect-changes.outputs.web == 'true' }}
            dockerfile: ./apps/web/Dockerfile
          - service: mobile
            condition: ${{ needs.detect-changes.outputs.mobile == 'true' }}
            dockerfile: ./apps/mobile/Dockerfile
          - service: api-gateway
            condition: ${{ needs.detect-changes.outputs.api-gateway == 'true' }}
            dockerfile: ./apps/api-gateway/Dockerfile
          - service: registry
            condition: ${{ needs.detect-changes.outputs.registry == 'true' }}
            dockerfile: ./apps/registry/Dockerfile
          - service: auth-service
            condition: ${{ needs.detect-changes.outputs.auth-service == 'true' }}
            dockerfile: ./services/auth-service/Dockerfile
          - service: user-service
            condition: ${{ needs.detect-changes.outputs.user-service == 'true' }}
            dockerfile: ./services/user-service/Dockerfile
          - service: workflow-service
            condition: ${{ needs.detect-changes.outputs.workflow-service == 'true' }}
            dockerfile: ./services/workflow-service/Dockerfile
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        if: matrix.condition == 'true'
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: matrix.condition == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        if: matrix.condition == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        if: matrix.condition == 'true'
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€é•œåƒ
        if: matrix.condition == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          target: ${{ matrix.service == 'mobile' && 'metro' || '' }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # è‡ªåŠ¨éƒ¨ç½²åˆ° staging çŽ¯å¢ƒ
  auto-deploy-staging:
    needs: [detect-changes, build-and-push]
    if: |
      needs.detect-changes.outputs.any-service == 'true' && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: ðŸš€ è§¦å‘éƒ¨ç½²åˆ° Staging
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'dev',
              inputs: {
                environment: 'staging',
                service: 'all',
                image_tag: 'dev',
                force_recreate: 'false'
              }
            });

  # åˆ›å»ºå‘å¸ƒæ ‡ç­¾æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  auto-deploy-production:
    needs: [detect-changes, build-and-push]
    if: |
      needs.detect-changes.outputs.any-service == 'true' && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ðŸ·ï¸ åˆ›å»ºå‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          TAG="v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git tag $TAG
          git push origin $TAG

      - name: ðŸš€ è§¦å‘éƒ¨ç½²åˆ° Production
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main',
              inputs: {
                environment: 'production',
                service: 'all',
                image_tag: 'latest',
                force_recreate: 'false'
              }
            });

  # æž„å»ºç»“æžœæ±‡æ€»
  summary:
    needs: [detect-changes, lint-and-test, build-and-push]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š CI/CD ç»“æžœæ±‡æ€»
        run: |
          echo "## ðŸ”„ CI/CD æµæ°´çº¿ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**å˜æ›´æ£€æµ‹:**" >> $GITHUB_STEP_SUMMARY
          echo "- Web: ${{ needs.detect-changes.outputs.web == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile: ${{ needs.detect-changes.outputs.mobile == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: ${{ needs.detect-changes.outputs.api-gateway == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: ${{ needs.detect-changes.outputs.registry == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.detect-changes.outputs.auth-service == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: ${{ needs.detect-changes.outputs.user-service == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Service: ${{ needs.detect-changes.outputs.workflow-service == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**æµæ°´çº¿çŠ¶æ€:**" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç æ£€æŸ¥: ${{ needs.lint-and-test.result == 'success' && 'âœ… é€šè¿‡' || needs.lint-and-test.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- é•œåƒæž„å»º: ${{ needs.build-and-push.result == 'success' && 'âœ… æˆåŠŸ' || needs.build-and-push.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**è§¦å‘ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- äº‹ä»¶: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
