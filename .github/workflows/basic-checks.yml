name: ðŸ” Basic Checks

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  # å‰ç«¯æ£€æŸ¥
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          # ä»Žæ ¹ç›®å½•å®‰è£…æ‰€æœ‰workspaceä¾èµ–
          pnpm install --frozen-lockfile

      - name: ðŸ” æ£€æŸ¥ Web åº”ç”¨
        run: |
          echo "ðŸ” è¿è¡Œ ESLint..."
          pnpm --filter ./apps/web lint
          echo "ðŸŽ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
          pnpm --filter ./apps/web format:check
          echo "ðŸ—ï¸ æž„å»ºæµ‹è¯•..."
          pnpm --filter ./apps/web build
          echo "âœ… Web åº”ç”¨æ£€æŸ¥å®Œæˆ"

  # åŽç«¯æ£€æŸ¥
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24.4"

      - name: ðŸ” æ£€æŸ¥ Go æœåŠ¡
        run: |
          echo "ðŸ” æ£€æŸ¥ Go æœåŠ¡..."

          # æ£€æŸ¥æ¯ä¸ªæœåŠ¡
          services=(
            "apps/api-gateway"
            "apps/registry" 
            "services/auth-service"
            "services/user-service"
            "services/workflow-service"
          )

          for service in "${services[@]}"; do
            echo "æ£€æŸ¥ $service..."
            
            if [[ ! -d "$service" ]]; then
              echo "âš ï¸ $service ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi
            
            cd "$service"
            
            if [[ ! -f "go.mod" ]]; then
              echo "âš ï¸ $service æ²¡æœ‰ go.mod æ–‡ä»¶ï¼Œè·³è¿‡"
              cd - > /dev/null
              continue
            fi
            
            echo "  ðŸ“¦ ä¸‹è½½ä¾èµ–..."
            go mod download || { echo "âŒ go mod download å¤±è´¥"; cd - > /dev/null; continue; }
            
            echo "  ðŸ§¹ æ•´ç†æ¨¡å—..."
            go mod tidy || { echo "âŒ go mod tidy å¤±è´¥"; cd - > /dev/null; continue; }
            
            echo "  ðŸŽ¨ æ ¼å¼æ£€æŸ¥..."
            if find . -name "*.go" | grep -q .; then
              go fmt ./... || { echo "âŒ go fmt å¤±è´¥"; cd - > /dev/null; continue; }
            fi
            
            echo "  ðŸ” é™æ€åˆ†æž..."
            if find . -name "*.go" | grep -q .; then
              go vet ./... || { echo "âŒ go vet å¤±è´¥"; cd - > /dev/null; continue; }
            fi
            
            echo "  ðŸ—ï¸ æž„å»ºæµ‹è¯•..."
            if [[ -d "cmd" ]]; then
              go build -v ./cmd/... || { echo "âŒ æž„å»ºå¤±è´¥"; cd - > /dev/null; continue; }
            fi
            
            echo "  âœ… $service æ£€æŸ¥é€šè¿‡"
            cd - > /dev/null
          done

          echo "âœ… åŽç«¯æ£€æŸ¥å®Œæˆ"

  # ç»“æžœæ±‡æ€»
  summary:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: always()
    steps:
      - name: ðŸ“Š æ£€æŸ¥ç»“æžœ
        run: |
          echo "## ðŸ” æ£€æŸ¥ç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.frontend.result }}" == "success" ]]; then
            echo "| å‰ç«¯æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å‰ç«¯æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.backend.result }}" == "success" ]]; then
            echo "| åŽç«¯æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| åŽç«¯æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.frontend.result }}" == "success" && "${{ needs.backend.result }}" == "success" ]]; then
            echo "ðŸŽ‰ æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
