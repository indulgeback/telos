name: ðŸ³ Build and Push Docker Images

on:
  workflow_dispatch:
    inputs:
      service:
        description: "é€‰æ‹©è¦æž„å»ºçš„æœåŠ¡"
        required: true
        default: "all"
        type: choice
        options:
          - "all"
          - "web"
          - "mobile"
          - "api-gateway"
          - "registry"
          - "auth-service"
          - "user-service"
          - "workflow-service"
      tag:
        description: "é•œåƒæ ‡ç­¾ (é»˜è®¤: latest)"
        required: false
        default: "latest"
        type: string
      push_to_registry:
        description: "æ˜¯å¦æŽ¨é€åˆ°é•œåƒä»“åº“"
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/telos

jobs:
  build-web:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'web' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-web
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Web é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-mobile:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'mobile' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mobile
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Mobile é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/mobile/Dockerfile
          target: metro
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-api-gateway:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'api-gateway' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api-gateway
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ API Gateway é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api-gateway/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-registry:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'registry' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-registry
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Registry é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/registry/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-auth-service:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'auth-service' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-auth-service
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Auth Service é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/auth-service/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-user-service:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'user-service' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-user-service
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ User Service é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/user-service/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-workflow-service:
    if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'workflow-service' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        if: ${{ github.event.inputs.push_to_registry == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-workflow-service
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Workflow Service é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/workflow-service/Dockerfile
          push: ${{ github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  summary:
    needs:
      [
        build-web,
        build-mobile,
        build-api-gateway,
        build-registry,
        build-auth-service,
        build-user-service,
        build-workflow-service,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š æž„å»ºç»“æžœæ±‡æ€»
        run: |
          echo "## ðŸ³ Docker é•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          services=("web" "mobile" "api-gateway" "registry" "auth-service" "user-service" "workflow-service")
          results=("${{ needs.build-web.result }}" "${{ needs.build-mobile.result }}" "${{ needs.build-api-gateway.result }}" "${{ needs.build-registry.result }}" "${{ needs.build-auth-service.result }}" "${{ needs.build-user-service.result }}" "${{ needs.build-workflow-service.result }}")

          for i in "${!services[@]}"; do
            service="${services[$i]}"
            result="${results[$i]}"
            
            if [[ "$result" == "success" ]]; then
              echo "| $service | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "failure" ]]; then
              echo "| $service | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "| $service | â­ï¸ è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $service | â¸ï¸ å–æ¶ˆ |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºå‚æ•°:**" >> $GITHUB_STEP_SUMMARY
          echo "- æœåŠ¡: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ ‡ç­¾: ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- æŽ¨é€åˆ°ä»“åº“: ${{ github.event.inputs.push_to_registry }}" >> $GITHUB_STEP_SUMMARY
          echo "- é•œåƒä»“åº“: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}" >> $GITHUB_STEP_SUMMARY
