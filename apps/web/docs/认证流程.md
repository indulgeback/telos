# Telos è®¤è¯ç³»ç»Ÿé›†æˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

Telos é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„è®¤è¯æ¶æ„ï¼Œç»“åˆ NextAuth.js å’Œåç«¯å¾®æœåŠ¡ï¼Œå®ç°äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’ŒçŠ¶æ€åŒæ­¥ç³»ç»Ÿã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†è®¤è¯ç³»ç»Ÿçš„å·¥ä½œåŸç†ã€é›†æˆæ–¹å¼å’Œæœ€ä½³å®è·µã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ (Next.js) â”‚â—„â”€â”€â–ºâ”‚  GitHub OAuth    â”‚    â”‚  åç«¯å¾®æœåŠ¡      â”‚
â”‚   + NextAuth.js â”‚    â”‚                  â”‚    â”‚  (Go Services)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                               â–²
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    API è°ƒç”¨åŒæ­¥ç”¨æˆ·çŠ¶æ€
```

### æ ¸å¿ƒç»„ä»¶

- **NextAuth.js**: å‰ç«¯è®¤è¯æ¡†æ¶ï¼Œå¤„ç† OAuth æµç¨‹
- **GitHub OAuth**: ç¬¬ä¸‰æ–¹è®¤è¯æä¾›è€…
- **JWT Strategy**: æ— æœåŠ¡å™¨å‹å¥½çš„ä¼šè¯ç®¡ç†
- **API Client**: ç»Ÿä¸€çš„åç«¯æ¥å£è°ƒç”¨
- **Go å¾®æœåŠ¡**: åç«¯è®¤è¯å’Œç”¨æˆ·ç®¡ç†æœåŠ¡

## ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯ NextAuth
    participant G as GitHub OAuth
    participant B as åç«¯ API

    U->>F: 1. ç‚¹å‡»ç™»å½•æŒ‰é’®
    F->>G: 2. é‡å®šå‘åˆ° GitHub
    G->>U: 3. ç”¨æˆ·æˆæƒç¡®è®¤
    G->>F: 4. è¿”å›æˆæƒç å’Œç”¨æˆ·ä¿¡æ¯

    Note over F: JWT å›è°ƒè§¦å‘
    F->>B: 5. POST /api/users/sync (åŒæ­¥ç”¨æˆ·)

    Note over F: SignIn äº‹ä»¶è§¦å‘
    F->>B: 6. POST /api/auth/signin (ç™»å½•è®°å½•)

    F->>U: 7. ç™»å½•å®Œæˆï¼Œé‡å®šå‘åˆ°åº”ç”¨
```

**è¯¦ç»†æ­¥éª¤è¯´æ˜**:

1. **OAuth è®¤è¯**: ç”¨æˆ·é€šè¿‡ GitHub OAuth å®Œæˆèº«ä»½éªŒè¯
2. **JWT å›è°ƒ**:
   - ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° JWT token
   - è°ƒç”¨ `/api/users/sync` ç¡®ä¿ç”¨æˆ·åœ¨åç«¯å­˜åœ¨
3. **Session æ„å»º**: å°† JWT ä¿¡æ¯ä¼ é€’ç»™å®¢æˆ·ç«¯ session
4. **ç™»å½•äº‹ä»¶**: è°ƒç”¨ `/api/auth/signin` è®°å½•ç™»å½•è¡Œä¸º
5. **å®Œæˆè®¤è¯**: ç”¨æˆ·è·å¾—å®Œæ•´çš„è®¤è¯çŠ¶æ€

### 2. ç”¨æˆ·ç™»å‡ºæµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯ NextAuth
    participant B as åç«¯ API

    U->>F: 1. ç‚¹å‡»ç™»å‡ºæŒ‰é’®
    F->>F: 2. æ¸…é™¤æœ¬åœ° session

    Note over F: SignOut äº‹ä»¶è§¦å‘
    F->>B: 3. POST /api/auth/signout

    F->>U: 4. ç™»å‡ºå®Œæˆï¼Œé‡å®šå‘
```

### 3. è·¯ç”±ä¿æŠ¤æœºåˆ¶

```typescript
// å—ä¿æŠ¤çš„è·¯ç”±åˆ—è¡¨
const protectedRoutes = [
  '/dashboard', // ä»ªè¡¨æ¿
  '/profile', // ç”¨æˆ·èµ„æ–™
  '/workflows', // å·¥ä½œæµç®¡ç†
  '/settings', // ç³»ç»Ÿè®¾ç½®
]

// ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
const isLoggedIn = !!auth?.user
const needsAuth = protectedRoutes.some(route =>
  nextUrl.pathname.includes(route)
)
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. NextAuth é…ç½® (`src/auth.ts`)

```typescript
const authConfig: NextAuthConfig = {
  providers: [
    GitHub({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    })
  ],
  session: {
    strategy: 'jwt',           // JWT ç­–ç•¥
    maxAge: 30 * 24 * 60 * 60, // 30 å¤©æœ‰æ•ˆæœŸ
    updateAge: 24 * 60 * 60,   // 24 å°æ—¶æ›´æ–°
  },
  callbacks: {
    // JWT å›è°ƒ - å¤„ç†ç”¨æˆ·ä¿¡æ¯å’Œåç«¯åŒæ­¥
    async jwt({ token, user, account }) { ... },

    // Session å›è°ƒ - æ„å»ºå®¢æˆ·ç«¯ä¼šè¯
    async session({ session, token }) { ... },

    // æˆæƒå›è°ƒ - è·¯ç”±ä¿æŠ¤
    async authorized({ auth, request }) { ... }
  },
  events: {
    // ç™»å½•äº‹ä»¶ - è°ƒç”¨åç«¯ç™»å½•æ¥å£
    async signIn({ user, account }) { ... },

    // ç™»å‡ºäº‹ä»¶ - è°ƒç”¨åç«¯ç™»å‡ºæ¥å£
    async signOut(message) { ... }
  }
}
```

### 2. API å®¢æˆ·ç«¯ (`src/lib/api-client.ts`)

```typescript
class ApiClient {
  // ç”¨æˆ·ç™»å½•æ¥å£
  async signIn(userData: SignInData): Promise<ApiResponse<AuthResponse>>

  // ç”¨æˆ·ç™»å‡ºæ¥å£
  async signOut(userId: string): Promise<ApiResponse>

  // ç”¨æˆ·ä¿¡æ¯åŒæ­¥æ¥å£
  async syncUser(userData: UserData): Promise<ApiResponse<AuthResponse>>
}
```

### 3. ç±»å‹å®šä¹‰ (`src/types/auth.ts`)

```typescript
// åŸºç¡€ç”¨æˆ·æ•°æ®
interface UserData {
  id: string
  email?: string | null
  name?: string | null
  image?: string | null
  provider: string
}

// ç™»å½•æ•°æ® (åŒ…å«è®¿é—®ä»¤ç‰Œ)
interface SignInData extends UserData {
  accessToken?: string
}

// ç»Ÿä¸€ API å“åº”æ ¼å¼
interface ApiResponse<T = any> {
  success: boolean
  data?: T
  message?: string
  error?: string
}
```

## ğŸŒ åç«¯ API æ¥å£è§„èŒƒ

### 1. ç”¨æˆ·ä¿¡æ¯åŒæ­¥æ¥å£

**æ¥å£**: `POST /api/users/sync`

**ç”¨é€”**: åœ¨ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°åç«¯æ•°æ®åº“

**è¯·æ±‚ä½“**:

```json
{
  "id": "github_user_123",
  "email": "user@example.com",
  "name": "å¼ ä¸‰",
  "image": "https://avatars.githubusercontent.com/u/123",
  "provider": "github"
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "github_user_123",
      "email": "user@example.com",
      "name": "å¼ ä¸‰",
      "avatar": "https://avatars.githubusercontent.com/u/123",
      "provider": "github",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "ç”¨æˆ·ä¿¡æ¯åŒæ­¥æˆåŠŸ"
}
```

### 2. ç”¨æˆ·ç™»å½•æ¥å£

**æ¥å£**: `POST /api/auth/signin`

**ç”¨é€”**: è®°å½•ç”¨æˆ·ç™»å½•è¡Œä¸ºï¼Œæ›´æ–°æœ€åç™»å½•æ—¶é—´

**è¯·æ±‚ä½“**:

```json
{
  "id": "github_user_123",
  "email": "user@example.com",
  "name": "å¼ ä¸‰",
  "image": "https://avatars.githubusercontent.com/u/123",
  "provider": "github",
  "accessToken": "gho_xxxxxxxxxxxx"
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "github_user_123",
      "email": "user@example.com",
      "name": "å¼ ä¸‰",
      "avatar": "https://avatars.githubusercontent.com/u/123",
      "provider": "github",
      "isActive": true,
      "lastLoginAt": "2024-01-01T12:00:00Z",
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T12:00:00Z"
    },
    "token": "jwt_token_here",
    "refreshToken": "refresh_token_here"
  },
  "message": "ç™»å½•æˆåŠŸ"
}
```

### 3. ç”¨æˆ·ç™»å‡ºæ¥å£

**æ¥å£**: `POST /api/auth/signout`

**ç”¨é€”**: è®°å½•ç”¨æˆ·ç™»å‡ºè¡Œä¸ºï¼Œæ¸…ç†æœåŠ¡ç«¯ä¼šè¯

**è¯·æ±‚ä½“**:

```json
{
  "userId": "github_user_123"
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "success": true,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

## âš™ï¸ ç¯å¢ƒé…ç½®

### å‰ç«¯ç¯å¢ƒå˜é‡ (`.env.local`)

```env
# NextAuth é…ç½®
AUTH_SECRET="P7Jnw8qrTDrbA9w200CYEGO9SrvN0DoO+ssJPI4h5UI="
NEXTAUTH_URL="http://localhost:8800"

# GitHub OAuth é…ç½®
GITHUB_CLIENT_ID="Ov23ct6a75nxrAI9WK8e"
GITHUB_CLIENT_SECRET="2e39aedd51666636515e20a4550efc0fc56b779a"

# API é…ç½®
NEXT_PUBLIC_API_URL="http://localhost:8890"

# åº”ç”¨é…ç½®
NEXT_PUBLIC_DOMAIN="localhost:8800"
NEXT_PUBLIC_NODE_ENV="development"
```

### GitHub OAuth åº”ç”¨è®¾ç½®

1. è®¿é—® [GitHub Developer Settings](https://github.com/settings/applications/new)
2. åˆ›å»ºæ–°çš„ OAuth App
3. é…ç½®å›è°ƒ URL: `http://localhost:8800/api/auth/callback/github`
4. è·å– Client ID å’Œ Client Secret

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
try {
  await apiClient.signIn(userData)
  console.log('åç«¯ç™»å½•æ¥å£è°ƒç”¨æˆåŠŸ')
} catch (error) {
  console.error('åç«¯ç™»å½•æ¥å£è°ƒç”¨å¤±è´¥:', error)
  // å…³é”®ï¼šä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…é˜»æ­¢ç”¨æˆ·ç™»å½•
}
```

**è®¾è®¡åŸåˆ™**:

- åç«¯ API è°ƒç”¨å¤±è´¥ä¸å½±å“å‰ç«¯ç™»å½•æµç¨‹
- ä¼˜é›…é™çº§ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### 2. ä¼šè¯ç®¡ç†

- **JWT ç­–ç•¥**: æ— çŠ¶æ€ï¼Œé€‚åˆå¾®æœåŠ¡æ¶æ„
- **è‡ªåŠ¨åˆ·æ–°**: 24å°æ—¶æ›´æ–°ä¸€æ¬¡ï¼Œä¿æŒä¼šè¯æ´»è·ƒ
- **å®‰å…¨è¿‡æœŸ**: 30å¤©ç»å¯¹è¿‡æœŸæ—¶é—´
- **è·¯ç”±ä¿æŠ¤**: ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥å—ä¿æŠ¤è·¯ç”±

### 3. ç±»å‹å®‰å…¨

- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- NextAuth ç±»å‹æ‰©å±•
- API è¯·æ±‚/å“åº”ç±»å‹æ£€æŸ¥
- ç¼–è¯‘æ—¶é”™è¯¯æ£€æµ‹

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨è®¤è¯

```typescript
import { useSession, signIn, signOut } from 'next-auth/react'

export function AuthButton() {
  const { data: session, status } = useSession()

  if (status === 'loading') return <p>åŠ è½½ä¸­...</p>

  if (session) {
    return (
      <div>
        <p>æ¬¢è¿, {session.user?.name}</p>
        <button onClick={() => signOut()}>ç™»å‡º</button>
      </div>
    )
  }

  return (
    <button onClick={() => signIn('github')}>
      ä½¿ç”¨ GitHub ç™»å½•
    </button>
  )
}
```

### 2. æœåŠ¡ç«¯è®¤è¯æ£€æŸ¥

```typescript
import { auth } from '@/auth'

export default async function ProtectedPage() {
  const session = await auth()

  if (!session) {
    redirect('/auth/signin')
  }

  return <div>å—ä¿æŠ¤çš„å†…å®¹</div>
}
```

### 3. API è·¯ç”±ä¿æŠ¤

```typescript
import { auth } from '@/auth'
import { NextRequest } from 'next/server'

export async function GET(request: NextRequest) {
  const session = await auth()

  if (!session) {
    return Response.json({ error: 'æœªæˆæƒ' }, { status: 401 })
  }

  // å¤„ç†å·²è®¤è¯çš„è¯·æ±‚
  return Response.json({ data: 'protected data' })
}
```

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### 1. å¼€å‘ç¯å¢ƒè°ƒè¯•

```typescript
// auth.ts ä¸­å¯ç”¨è°ƒè¯•æ¨¡å¼
debug: process.env.NODE_ENV === 'development'
```

### 2. æ—¥å¿—ç›‘æ§

```typescript
// ç™»å½•æˆåŠŸæ—¥å¿—
console.log('ç”¨æˆ·ç™»å½•:', {
  user: user.email,
  provider: account?.provider,
  timestamp: new Date().toISOString(),
})

// åç«¯ API è°ƒç”¨æ—¥å¿—
console.log('åç«¯ç™»å½•æ¥å£è°ƒç”¨æˆåŠŸ')
console.error('åç«¯ç™»å½•æ¥å£è°ƒç”¨å¤±è´¥:', error)
```

### 3. é”™è¯¯è¿½è¸ª

- å‰ç«¯é”™è¯¯ä¸ä¼šé˜»æ–­è®¤è¯æµç¨‹
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è®°å½•åˆ°æ§åˆ¶å°
- åŒºåˆ†å‰ç«¯è®¤è¯é”™è¯¯å’Œåç«¯ API é”™è¯¯

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼€å‘å»ºè®®

- **æ¸è¿›å¼é›†æˆ**: å…ˆç¡®ä¿å‰ç«¯è®¤è¯å·¥ä½œï¼Œå†é›†æˆåç«¯ API
- **é”™è¯¯å®¹é”™**: åç«¯æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œå‰ç«¯è®¤è¯ä»åº”æ­£å¸¸å·¥ä½œ
- **ç±»å‹ä¼˜å…ˆ**: ä½¿ç”¨ TypeScript ç¡®ä¿ç±»å‹å®‰å…¨
- **ç¯å¢ƒéš”ç¦»**: å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒåˆ†åˆ«é…ç½®

### 2. å®‰å…¨å»ºè®®

- **å¯†é’¥ç®¡ç†**: ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- **ä»¤ç‰Œè¿‡æœŸ**: åˆç†è®¾ç½®ä¼šè¯è¿‡æœŸæ—¶é—´
- **æƒé™æ§åˆ¶**: å®ç°ç»†ç²’åº¦çš„æƒé™ç®¡ç†

### 3. æ€§èƒ½ä¼˜åŒ–

- **JWT ç­–ç•¥**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- **ä¼šè¯ç¼“å­˜**: åˆç†ä½¿ç”¨ä¼šè¯ç¼“å­˜
- **å¼‚æ­¥å¤„ç†**: åç«¯ API è°ƒç”¨ä¸é˜»å¡ç”¨æˆ·æ“ä½œ
- **é”™è¯¯é‡è¯•**: å®ç°åˆç†çš„é‡è¯•æœºåˆ¶

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **GitHub OAuth é…ç½®é”™è¯¯**
   - æ£€æŸ¥ Client ID å’Œ Secret
   - ç¡®è®¤å›è°ƒ URL é…ç½®æ­£ç¡®

2. **åç«¯ API è°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥ API åœ°å€é…ç½®
   - ç¡®è®¤åç«¯æœåŠ¡è¿è¡ŒçŠ¶æ€
   - æŸ¥çœ‹ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

3. **ä¼šè¯çŠ¶æ€å¼‚å¸¸**
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Cookie
   - æ£€æŸ¥ AUTH_SECRET é…ç½®
   - ç¡®è®¤æ—¶åŒºå’Œæ—¶é—´åŒæ­¥

4. **ç±»å‹é”™è¯¯**
   - æ›´æ–° TypeScript ç±»å‹å®šä¹‰
   - æ£€æŸ¥ NextAuth ç‰ˆæœ¬å…¼å®¹æ€§
   - é‡æ–°å®‰è£…ä¾èµ–åŒ…

### è°ƒè¯•æ­¥éª¤

1. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
2. æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ§åˆ¶å°
3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚å’Œå“åº”
4. ç¡®è®¤åç«¯æœåŠ¡æ—¥å¿—
5. éªŒè¯æ•°æ®åº“è¿æ¥å’Œæ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [NextAuth.js å®˜æ–¹æ–‡æ¡£](https://next-auth.js.org/)
- [GitHub OAuth åº”ç”¨è®¾ç½®](https://docs.github.com/en/developers/apps/building-oauth-apps)
- [JWT æœ€ä½³å®è·µ](https://tools.ietf.org/html/rfc7519)
- [Next.js ä¸­é—´ä»¶æ–‡æ¡£](https://nextjs.org/docs/app/building-your-application/routing/middleware)

---

**æ›´æ–°æ—¥æœŸ**: 2025.7.29
**ç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤è€…**: Telos å¼€å‘å›¢é˜Ÿ
